<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Support Admin · InfraForge Labs</title>
  <link rel="stylesheet" href="/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .ticket-item { cursor: pointer; padding: 6px 0; }
    .ticket-item:hover { text-decoration: underline; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-left: 6px;
    }
    .priority-low { background: #334155; }
    .priority-normal { background: #2563eb; }
    .priority-high { background: #f59e0b; }
    .priority-urgent { background: #dc2626; }

    .status {
      font-size: 12px;
      color: #9ca3af;
    }

    img {
      max-width: 320px;
      display: block;
      margin-top: 6px;
      border-radius: 6px;
    }
  </style>
</head>

<body>
<main class="container">
  <h1>Support Admin</h1>
  <p class="subtitle">Internal support dashboard · InfraForge Labs</p>

  <p>← <a href="/">Back to InfraForge Labs</a></p>

  <!-- TICKETS -->
  <section class="card">
    <h2>Tickets</h2>
    <input id="search" placeholder="Search tickets" oninput="renderTickets()" />
    <div id="tickets">Loading tickets…</div>
  </section>

  <!-- CONVERSATION -->
  <section class="card">
    <h2>Conversation</h2>

    <div id="ticketMeta"></div>
    <div id="conversation">Select a ticket</div>

    <hr />

    <h3>Reply</h3>
    <textarea id="replyBody" rows="4" placeholder="Type reply…"></textarea>
    <button onclick="sendReply()">Send Reply</button>

    <hr />

    <h3>Attachments</h3>
    <div id="attachments">No attachments</div>
  </section>

  <!-- AUDIT -->
  <section class="card">
    <h2>Audit Log</h2>
    <div id="audit">Select a ticket</div>
  </section>

  <footer>
    <p>Internal use only · InfraForge Labs</p>
  </footer>
</main>

<script>
let tickets = [];
let selectedCode = null;

/* LOAD TICKETS */
async function loadTickets() {
  const res = await fetch("/support/api/admin/tickets");
  const data = await res.json();
  tickets = data.tickets || [];
  renderTickets();
}

function renderTickets() {
  const q = search.value.toLowerCase();
  const list = tickets.filter(t =>
    t.ticket_code.toLowerCase().includes(q) ||
    t.subject.toLowerCase().includes(q)
  );

  ticketsDiv.innerHTML =
    list.length === 0
      ? "<p>No tickets</p>"
      : list.map(t => `
        <div class="ticket-item" onclick="openTicket('${t.ticket_code}')">
          <strong>${t.ticket_code}</strong>
          <span class="badge priority-${t.priority}">${t.priority}</span><br>
          ${t.subject}
          <div class="status">Status: ${t.status}</div>
        </div>
      `).join("");
}

/* OPEN TICKET */
async function openTicket(code) {
  selectedCode = code;

  const res = await fetch(`/support/api/admin/ticket/${code}`);
  const data = await res.json();

  ticketMeta.innerHTML = `
    <strong>${data.ticket.ticket_code}</strong><br>
    Status:
    <select onchange="updateStatus(this.value)">
      ${["open","resolved","closed"].map(s =>
        `<option ${s===data.ticket.status?"selected":""}>${s}</option>`
      ).join("")}
    </select>
  `;

  conversation.innerHTML =
    data.replies.length === 0
      ? "No messages"
      : data.replies.map(r => `
        <div>
          <strong>${r.author_type}</strong>
          <small>${r.created_at}</small>
          <div>${r.body}</div>
        </div>
      `).join("");

  attachments.innerHTML =
    data.attachments.length === 0
      ? "No attachments"
      : data.attachments.map(a =>
          a.mime_type.startsWith("image/")
            ? `<img src="${a.public_url}">`
            : `<a href="${a.public_url}">${a.filename}</a>`
        ).join("");

  audit.innerHTML =
    data.auditLog.map(a =>
      `<p>[${a.created_at}] ${a.action}</p>`
    ).join("");
}

/* STATUS UPDATE */
async function updateStatus(status) {
  await fetch("/support/api/admin/status", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      ticketCode: selectedCode,
      status
    })
  });
  loadTickets();
}

/* SEND REPLY */
async function sendReply() {
  if (!selectedCode || !replyBody.value.trim()) return;

  await fetch("/support/api/admin/reply", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      ticketCode: selectedCode,
      message: replyBody.value
    })
  });

  replyBody.value = "";
  openTicket(selectedCode);
}

const ticketsDiv = document.getElementById("tickets");
const conversation = document.getElementById("conversation");
const attachments = document.getElementById("attachments");
const audit = document.getElementById("audit");
const search = document.getElementById("search");
const replyBody = document.getElementById("replyBody");
const ticketMeta = document.getElementById("ticketMeta");

loadTickets();
</script>
</body>
</html>
