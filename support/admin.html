<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Support Admin · InfraForge Labs</title>
  <link rel="stylesheet" href="/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
  <main class="container">
    <h1>Support Admin</h1>
    <p class="subtitle">Internal support dashboard · InfraForge Labs</p>

    <p>
      ← <a href="/">Back to InfraForge Labs</a>
    </p>

    <!-- TICKETS -->
    <section class="card">
      <h2>Tickets</h2>
      <input
        id="search"
        placeholder="Search by ticket ID, subject, email"
        oninput="renderTickets()"
      />
      <div id="tickets">Loading tickets…</div>
    </section>

    <!-- CONVERSATION -->
    <section class="card">
      <h2>Conversation</h2>
      <div id="conversation">Select a ticket to view details</div>

      <hr />

      <h3>Reply</h3>
      <textarea
        id="replyBody"
        rows="4"
        placeholder="Type your reply…"
      ></textarea>
      <br /><br />
      <button onclick="sendReply()">Send Reply</button>

      <hr />

      <h3>Attachments</h3>
      <div id="attachments">No attachments</div>

      <input type="file" id="fileInput" />
      <button onclick="uploadImage()">Upload image</button>
    </section>

    <!-- AUDIT LOG -->
    <section class="card">
      <h2>Audit Log</h2>
      <div id="audit">Select a ticket</div>
    </section>

    <footer>
      <p>Internal use only · InfraForge Labs</p>
    </footer>
  </main>

<script>
let tickets = [];
let selectedTicket = null;

/* ---------------- LOAD TICKETS ---------------- */
async function loadTickets() {
  const res = await fetch("/support/api/admin/tickets");
  const data = await res.json();
  tickets = data.tickets || [];
  renderTickets();
}

function renderTickets() {
  const q = document.getElementById("search").value.toLowerCase();
  const list = tickets.filter(t =>
    t.ticket_id.toLowerCase().includes(q) ||
    t.subject.toLowerCase().includes(q) ||
    t.from_email.toLowerCase().includes(q)
  );

  document.getElementById("tickets").innerHTML =
    list.length === 0
      ? "<p>No tickets</p>"
      : list.map(t => `
        <p>
          <a href="#" onclick="openTicket('${t.ticket_id}')">
            ${t.ticket_id}
          </a>
          — ${t.subject}
        </p>
      `).join("");
}

/* ---------------- OPEN TICKET ---------------- */
async function openTicket(ticketId) {
  selectedTicket = ticketId;

  const res = await fetch(
    `/support/api/admin/read?ticket_id=${ticketId}`
  );
  const data = await res.json();

  // Conversation
  document.getElementById("conversation").innerHTML =
    data.replies.length === 0
      ? "No messages"
      : data.replies.map(r => `
        <div class="message">
          <strong>${r.from_email}</strong><br/>
          ${r.body}<br/>
          <small>${r.created_at || ""}</small>
        </div>
      `).join("");

  // Attachments
  document.getElementById("attachments").innerHTML =
    data.attachments.length === 0
      ? "No attachments"
      : data.attachments.map(a =>
          `<img src="https://attachments.infraforgelabs.in/${a.r2_key}"
                style="max-width:300px; margin-bottom:10px; display:block" />`
        ).join("");

  loadAudit(ticketId);
}

/* ---------------- SEND REPLY ---------------- */
async function sendReply() {
  const body = document.getElementById("replyBody").value.trim();

  if (!selectedTicket || !body) {
    alert("Select a ticket and write a reply");
    return;
  }

  await fetch("/reply", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      ticket_id: selectedTicket,
      body
    })
  });

  document.getElementById("replyBody").value = "";
  openTicket(selectedTicket);
}

/* ---------------- UPLOAD IMAGE ---------------- */
async function uploadImage() {
  const file = document.getElementById("fileInput").files[0];

  if (!selectedTicket || !file) {
    alert("Select ticket and file");
    return;
  }

  const form = new FormData();
  form.append("file", file);
  form.append("ticket_id", selectedTicket);

  await fetch("/support/api/admin/upload", {
    method: "POST",
    body: form
  });

  document.getElementById("fileInput").value = "";
  openTicket(selectedTicket);
}

/* ---------------- AUDIT LOG ---------------- */
async function loadAudit(ticketId) {
  const res = await fetch(
    `/support/api/admin/audit?ticket_id=${ticketId}`
  );
  const data = await res.json();

  document.getElementById("audit").innerHTML =
    data.logs.length === 0
      ? "No audit events"
      : data.logs.map(l =>
          `<p>[${l.created_at}] ${l.action} by ${l.actor}</p>`
        ).join("");
}

loadTickets();
</script>
</body>
</html>
