<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Support Admin · InfraForge Labs</title>
  <link rel="stylesheet" href="/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>

<header class="header">
  <h1>Support Admin</h1>
  <p class="subtitle">Internal support dashboard · InfraForge Labs</p>
  <a href="/" class="back-link">← Back to InfraForge Labs</a>
</header>

<main class="container">

  <!-- TICKETS LIST -->
  <section class="card">
    <h2>Tickets</h2>

    <input
      type="text"
      id="search"
      placeholder="Search by ticket ID, subject, email…"
      class="input"
    />

    <div id="tickets">Loading tickets…</div>
  </section>

  <!-- CONVERSATION -->
  <section class="card">
    <h2>Conversation</h2>
    <div id="conversation">Select a ticket to view details</div>

    <div id="attachmentsSection" style="display:none">
      <h3>Attachments</h3>
      <div id="attachments" class="attachments"></div>

      <form id="uploadForm">
        <input type="file" name="file" accept="image/*" />
        <button type="submit">Upload image</button>
      </form>
    </div>

    <form id="replyForm" style="display:none">
      <textarea
        id="replyBody"
        placeholder="Write a reply…"
        class="textarea"
        required
      ></textarea>

      <button type="submit">Send reply</button>
      <button type="button" id="closeBtn">Close ticket</button>
    </form>
  </section>

  <!-- AUDIT LOG -->
  <section class="card">
    <h2>Audit Log</h2>
    <div id="audit">Select a ticket</div>
  </section>

</main>

<footer class="footer">
  Internal use only · InfraForge Labs
</footer>

<script>
let allTickets = [];
let currentTicketId = null;

async function loadTickets() {
  const res = await fetch("/support/api/admin/tickets");
  const data = await res.json();
  allTickets = data.tickets || [];
  renderTickets(allTickets);
}

function renderTickets(list) {
  const box = document.getElementById("tickets");

  if (!list.length) {
    box.innerHTML = "<p>No tickets</p>";
    return;
  }

  box.innerHTML = list.map(t => `
    <p>
      <a href="#" onclick="openTicket('${t.ticket_id}')">
        ${t.ticket_id}
      </a>
      — ${t.subject}
      <span class="status">[${t.status}]</span>
      ${t.sla_breached ? "<span class='sla'>⏰ SLA BREACHED</span>" : ""}
    </p>
  `).join("");
}

document.getElementById("search").oninput = e => {
  const q = e.target.value.toLowerCase();
  renderTickets(
    allTickets.filter(t =>
      t.ticket_id.toLowerCase().includes(q) ||
      t.subject.toLowerCase().includes(q) ||
      t.from_email.toLowerCase().includes(q)
    )
  );
};

async function openTicket(ticketId) {
  currentTicketId = ticketId;

  const res = await fetch(`/support/api/admin/read?ticket_id=${ticketId}`);
  const data = await res.json();

  // Conversation
  const conv = document.getElementById("conversation");
  conv.innerHTML = data.replies.map(r => `
    <div class="message ${r.direction}">
      <strong>${r.from_email}</strong>
      <pre>${r.body}</pre>
      <small>${r.created_at}</small>
    </div>
  `).join("");

  // Attachments
  const attBox = document.getElementById("attachments");
  const attSection = document.getElementById("attachmentsSection");
  attSection.style.display = "block";

  attBox.innerHTML = data.attachments.length
    ? data.attachments.map(a => `
        <img
          src="/support/api/attachments/view?key=${encodeURIComponent(a.r2_key)}"
          alt="${a.filename}"
          class="attachment-img"
        />
      `).join("")
    : "<p>No attachments</p>";

  // Audit log
  const auditRes = await fetch(`/support/api/admin/audit?ticket_id=${ticketId}`);
  const audit = await auditRes.json();
  document.getElementById("audit").innerHTML =
    audit.logs.map(l =>
      `<p>${l.created_at} — ${l.actor} — ${l.action}</p>`
    ).join("");

  document.getElementById("replyForm").style.display = "block";
}

// Reply
document.getElementById("replyForm").onsubmit = async e => {
  e.preventDefault();

  await fetch("/reply", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      ticket_id: currentTicketId,
      body: document.getElementById("replyBody").value
    })
  });

  document.getElementById("replyBody").value = "";
  openTicket(currentTicketId);
};

// Close ticket
document.getElementById("closeBtn").onclick = async () => {
  await fetch("/support/api/admin/status", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      ticket_id: currentTicketId,
      status: "closed"
    })
  });
  loadTickets();
  openTicket(currentTicketId);
};

// Upload attachment
document.getElementById("uploadForm").onsubmit = async e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  fd.append("ticket_id", currentTicketId);

  await fetch("/support/api/attachments/upload", {
    method: "POST",
    body: fd
  });

  e.target.reset();
  openTicket(currentTicketId);
};

// Initial load
loadTickets();
</script>

</body>
</html>
