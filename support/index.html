<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Support ¬∑ InfraForge Labs</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/style.css">

<style>
.card { max-width:760px; margin:20px auto; }
input, textarea, button { width:100%; padding:10px; margin:8px 0; }
.hidden { display:none; }

.logout { float:right; cursor:pointer; color:#ef4444; }

.ticket {
  cursor:pointer;
  padding:8px;
  border-bottom:1px solid #333;
}
.ticket.active {
  background:#111827;
}

.thread {
  margin-top:10px;
}

.reply {
  max-width:85%;
  margin-bottom:14px;
  padding:10px;
  border-radius:8px;
}

.reply.user {
  background:#1f2937;
  margin-left:auto;
  text-align:right;
}

.reply.admin {
  background:#0f172a;
  margin-right:auto;
}

.reply .author {
  font-size:12px;
  opacity:.7;
  margin-bottom:4px;
}

.attachment img {
  max-width:220px;
  margin-top:6px;
  border-radius:6px;
  display:block;
}

.attachment a {
  display:inline-block;
  margin-top:6px;
  font-size:14px;
}
</style>
</head>

<body>

<header>
  <h1>Support</h1>
</header>

<main>
<a href="/">‚Üê Back</a>

<!-- LOGIN -->
<section id="loginSection" class="card">
  <input id="fullName" placeholder="Full name">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
</section>

<!-- APP -->
<section id="appSection" class="hidden">

  <!-- CREATE -->
  <div class="card">
    <h3>Create Ticket <span id="logoutBtn" class="logout">Logout</span></h3>
    <input id="subject" placeholder="Subject">
    <textarea id="message" placeholder="Describe your issue"></textarea>
    <input id="file" type="file">
    <button id="createBtn">Submit Ticket</button>
    <p id="createMsg"></p>
  </div>

  <!-- TICKETS -->
  <div class="card">
    <h3>My Tickets</h3>
    <div id="ticketsList">Loading‚Ä¶</div>
  </div>

  <!-- THREAD -->
  <div class="card hidden" id="threadCard">
    <h3>Ticket <span id="activeTicketCode"></span></h3>

    <div id="thread" class="thread"></div>

    <textarea id="replyText" placeholder="Reply‚Ä¶"></textarea>
    <input id="replyFile" type="file">
    <button id="replyBtn">Send Reply</button>

    <p style="font-size:12px;opacity:.7">
      üí° You can also reply via email using the magic reply link.
    </p>
  </div>

</section>
</main>

<script>
const API = "https://api.infraforgelabs.in/support";

/* ---------- HELPERS ---------- */
const token = () => localStorage.getItem("support_token");

/* ---------- DOM ---------- */
const loginSection = document.getElementById("loginSection");
const appSection = document.getElementById("appSection");
const threadCard = document.getElementById("threadCard");

const ticketsList = document.getElementById("ticketsList");
const thread = document.getElementById("thread");
const activeTicketCodeEl = document.getElementById("activeTicketCode");

const createBtn = document.getElementById("createBtn");
const replyBtn = document.getElementById("replyBtn");

const subject = document.getElementById("subject");
const message = document.getElementById("message");
const file = document.getElementById("file");
const replyText = document.getElementById("replyText");
const replyFile = document.getElementById("replyFile");

let activeTicket = null;

/* ---------- INIT ---------- */
if (token()) {
  loginSection.classList.add("hidden");
  appSection.classList.remove("hidden");
  loadTickets();
}

/* ---------- LOAD TICKETS ---------- */
async function loadTickets() {
  const res = await fetch(`${API}/user/tickets`, {
    headers:{ Authorization:`Bearer ${token()}` }
  });
  const data = await res.json();

  ticketsList.innerHTML = data.tickets.map(t =>
    `<div class="ticket ${t.ticket_code === activeTicket ? "active" : ""}"
          onclick="openTicket('${t.ticket_code}')">
       ${t.subject}
     </div>`
  ).join("");
}

/* ---------- OPEN TICKET (THREAD) ---------- */
async function openTicket(code) {
  activeTicket = code;
  activeTicketCodeEl.textContent = code;
  threadCard.classList.remove("hidden");
  thread.innerHTML = "Loading‚Ä¶";

  loadTickets();

  const res = await fetch(`${API}/user/ticket/${code}`, {
    headers:{ Authorization:`Bearer ${token()}` }
  });
  const data = await res.json();

  thread.innerHTML = data.replies.map(r => {
    const files = (data.attachments || [])
      .filter(a => a.reply_id === r.id)
      .map(a =>
        a.mime_type.startsWith("image/")
          ? `<div class="attachment"><img src="${a.public_url}"></div>`
          : `<div class="attachment"><a href="${a.public_url}" target="_blank">${a.filename}</a></div>`
      ).join("");

    return `
      <div class="reply ${r.author_type === "user" ? "user" : "admin"}">
        <div class="author">${r.author_name}</div>
        ${r.body}
        ${files}
      </div>
    `;
  }).join("");
}

/* ---------- CREATE ---------- */
createBtn.onclick = async () => {
  const fd = new FormData();
  fd.append("subject", subject.value);
  fd.append("message", message.value);
  if (file.files[0]) fd.append("file", file.files[0]);

  const res = await fetch(`${API}/user/ticket`, {
    method:"POST",
    headers:{ Authorization:`Bearer ${token()}` },
    body:fd
  });
  const data = await res.json();

  subject.value = "";
  message.value = "";
  file.value = "";

  loadTickets();
  openTicket(data.ticketCode);
};

/* ---------- REPLY ---------- */
replyBtn.onclick = async () => {
  if (!activeTicket || !replyText.value.trim()) return;

  const fd = new FormData();
  fd.append("message", replyText.value.trim());
  if (replyFile.files[0]) fd.append("file", replyFile.files[0]);

  await fetch(`${API}/user/reply/${activeTicket}`, {
    method:"POST",
    headers:{ Authorization:`Bearer ${token()}` },
    body:fd
  });

  replyText.value = "";
  replyFile.value = "";
  openTicket(activeTicket);
};
</script>

</body>
</html>
