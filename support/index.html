<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Support · InfraForge Labs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/style.css">
  <style>
    .card { max-width: 720px; margin: auto; }
    input, textarea, button { width: 100%; margin: 8px 0; padding: 10px; }

    .ticket { padding: 8px; border-bottom: 1px solid #333; cursor:pointer }
    .reply { border-top:1px solid #333; padding-top:10px; margin-top:10px }

    .badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 6px;
      color: #fff;
    }

    .open { background:#2563eb }
    .resolved { background:#16a34a }
    .closed { background:#6b7280 }

    .unread {
      background:#dc2626;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity:1 }
      50% { opacity:0.5 }
      100% { opacity:1 }
    }

    .danger { background:#dc2626; color:#fff }
  </style>
</head>

<body>
<header>
  <img src="/logo.png" class="logo">
  <h1>Support</h1>
</header>

<main>
<div class="breadcrumb">
  <a href="/">← Back to InfraForge Labs</a>
</div>

<section id="ticketsSection">
  <div class="card">
    <h3>My Tickets</h3>
    <div id="ticketList"></div>
  </div>
</section>

<section id="ticketSection" style="display:none;">
  <div class="card">
    <h3>Conversation</h3>
    <div id="conversation"></div>

    <button class="danger" onclick="closeTicket()">Close Ticket</button>

    <hr>
    <textarea id="replyText"></textarea>
    <button onclick="sendReply()">Send Reply</button>
  </div>
</section>
</main>

<script>
const API="/support/api";
const token=localStorage.getItem("support_token");
let currentTicket=null;

/* LOAD TICKETS */
async function loadTickets() {
  const res=await fetch(API+"/user/tickets",{headers:{Authorization:"Bearer "+token}});
  const data=await res.json();

  ticketList.innerHTML=data.tickets.map(t=>`
    <div class="ticket" onclick="openTicket('${t.ticket_code}')">
      ${t.subject}
      <span class="badge ${t.status}">${t.status}</span>
      ${t.has_unread_user?'<span class="badge unread">NEW</span>':""}
    </div>
  `).join("");
}

/* OPEN TICKET */
async function openTicket(code) {
  currentTicket=code;
  const res=await fetch(API+"/user/ticket/"+code,{headers:{Authorization:"Bearer "+token}});
  const data=await res.json();

  ticketSection.style.display="block";

  conversation.innerHTML=data.replies.map(r=>`
    <div class="reply">
      <strong>${r.author_name}</strong><br>${r.body}
    </div>
  `).join("");
}

/* SEND REPLY */
async function sendReply() {
  const form=new FormData();
  form.append("message",replyText.value);

  await fetch(API+"/user/reply/"+currentTicket,{
    method:"POST",
    headers:{Authorization:"Bearer "+token},
    body:form
  });

  replyText.value="";
  openTicket(currentTicket);
}

/* CLOSE TICKET */
async function closeTicket() {
  await fetch(API+"/user/close/"+currentTicket,{
    method:"POST",
    headers:{Authorization:"Bearer "+token}
  });
  ticketSection.style.display="none";
  loadTickets();
}

loadTickets();
</script>
</body>
</html>
