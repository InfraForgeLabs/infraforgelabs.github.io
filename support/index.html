<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Support · InfraForge Labs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .card { max-width: 760px; margin: auto; }
    input, textarea, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
    }
    .ticket-item { cursor: pointer; padding: 6px 0; }
    .ticket-item:hover { text-decoration: underline; }
    .badge {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-left: 6px;
      background: #2563eb;
    }
    .badge.unread { background: #dc2626; }
    .badge.closed { background: #374151; }
    .logout {
      float: right;
      cursor: pointer;
      color: #f87171;
      font-size: 14px;
    }
    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>

<body>

<header>
  <img src="/logo.png" class="logo">
  <h1>Support</h1>
  <p class="subtitle">InfraForge · DevOpsMind · InfraForge Labs</p>
</header>

<main>
  <div class="breadcrumb">
    <a href="/">← Back to InfraForge Labs</a>
  </div>

  <!-- LOGIN -->
  <section id="loginSection">
    <div class="card">
      <h3>Login</h3>
      <input id="loginEmail" type="email" placeholder="Email">
      <input id="loginPassword" type="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <p id="loginResult"></p>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboardSection" style="display:none;">
    <div class="card">
      <h3>
        Create Ticket
        <span class="logout" onclick="logout()">Logout</span>
      </h3>
      <input id="subject" placeholder="Subject">
      <textarea id="message" rows="4" placeholder="Describe your issue"></textarea>
      <button onclick="createTicket()">Submit Ticket</button>
      <p id="createResult"></p>
    </div>

    <br>

    <div class="card">
      <h3>My Tickets</h3>
      <div id="tickets"></div>
    </div>

    <br>

    <div class="card">
      <h3>Conversation</h3>
      <div id="conversation">Select a ticket</div>

      <button id="closeBtn" style="display:none;background:#dc2626;"
        onclick="closeTicket()">Close Ticket</button>

      <button id="reopenBtn" style="display:none;background:#16a34a;"
        onclick="reopenTicket()">Reopen Ticket</button>

      <textarea id="replyText" rows="4" placeholder="Reply…"></textarea>
      <button id="replyBtn" onclick="sendReply()">Send Reply</button>
    </div>
  </section>
</main>

<footer>© InfraForge Labs · Support</footer>

<script>
const API = "/support/api";
let token = localStorage.getItem("support_token");
let selectedCode = null;
let selectedStatus = null;

/* ---------- AUTH ---------- */
async function login() {
  const res = await fetch(`${API}/user/auth`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email: loginEmail.value,
      password: loginPassword.value,
      fullName: "login"
    })
  });
  const data = await res.json();
  if (!data.ok) return loginResult.textContent = data.error;
  localStorage.setItem("support_token", data.token);
  token = data.token;
  showDashboard();
}

function logout() {
  localStorage.clear();
  location.href = "/support/";
}

/* ---------- DASHBOARD ---------- */
function showDashboard() {
  loginSection.style.display = "none";
  dashboardSection.style.display = "block";
  loadTickets();
}

/* ---------- CREATE ---------- */
async function createTicket() {
  const res = await fetch(`${API}/ticket`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: JSON.stringify({
      subject: subject.value,
      message: message.value
    })
  });
  const data = await res.json();
  if (!data.ok) return createResult.textContent = data.error;
  createResult.textContent = "Created: " + data.ticketCode;
  loadTickets();
}

/* ---------- LOAD ---------- */
async function loadTickets() {
  const res = await fetch(`${API}/user/tickets`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  tickets.innerHTML = data.tickets.map(t => `
    <div class="ticket-item" onclick="openTicket('${t.ticket_code}')">
      ${t.subject}
      <span class="badge ${t.unread ? "unread" : ""}">
        ${t.unread ? "NEW" : t.status.toUpperCase()}
      </span>
    </div>
  `).join("");
}

/* ---------- OPEN ---------- */
async function openTicket(code) {
  selectedCode = code;
  const res = await fetch(`${API}/user/ticket/${code}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();

  selectedStatus = data.ticket.status;
  conversation.innerHTML = data.replies.map(r =>
    `<div><strong>${r.author_name}</strong><br>${r.body}</div>`
  ).join("");

  replyText.disabled = replyBtn.disabled = selectedStatus === "closed";
  closeBtn.style.display = selectedStatus === "open" ? "block" : "none";
  reopenBtn.style.display = selectedStatus === "closed" ? "block" : "none";
}

/* ---------- REPLY ---------- */
async function sendReply() {
  if (selectedStatus === "closed") return;
  await fetch(`${API}/user/reply/${selectedCode}`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: new URLSearchParams({ message: replyText.value })
  });
  replyText.value = "";
  openTicket(selectedCode);
}

/* ---------- STATUS ---------- */
async function closeTicket() {
  await sendSystem("[User closed ticket]");
  loadTickets();
}
async function reopenTicket() {
  await sendSystem("[User reopened ticket]");
  loadTickets();
}
async function sendSystem(msg) {
  await fetch(`${API}/user/reply/${selectedCode}`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: new URLSearchParams({ message: msg })
  });
}

/* ---------- DEEP LINK ---------- */
const qs = new URLSearchParams(location.search);
if (qs.get("token")) {
  localStorage.setItem("support_token", qs.get("token"));
  token = qs.get("token");
  history.replaceState({}, "", "/support/");
}
if (token) showDashboard();
</script>

</body>
</html>
