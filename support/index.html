<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Support · InfraForge Labs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .card { max-width: 760px; margin: auto; }
    input, textarea, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
    }
    .ticket-item { cursor: pointer; padding: 6px 0; }
    .ticket-item:hover { text-decoration: underline; }
    .badge {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-left: 6px;
      background: #2563eb;
    }
    .logout {
      float: right;
      cursor: pointer;
      color: #f87171;
      font-size: 14px;
    }
    hr { margin: 24px 0; }
  </style>
</head>

<body>

<header>
  <img src="/logo.png" class="logo" alt="InfraForge Labs logo">
  <h1>Support</h1>
  <p class="subtitle">InfraForge · DevOpsMind · InfraForge Labs</p>
</header>

<main>

  <div class="breadcrumb">
    <a href="/">← Back to InfraForge Labs</a>
  </div>

  <!-- ================= LOGIN ================= -->
  <section id="loginSection">
    <div class="card">
      <h3>Login</h3>
      <input id="loginEmail" type="email" placeholder="Email" />
      <input id="loginPassword" type="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p id="loginResult"></p>
    </div>
  </section>

  <!-- ================= DASHBOARD ================= -->
  <section id="dashboardSection" style="display:none;">

    <!-- CREATE TICKET -->
    <div class="card">
      <h3>
        Create Ticket
        <span class="logout" onclick="logout()">Logout</span>
      </h3>

      <input id="subject" placeholder="Subject" />
      <textarea id="message" rows="5" placeholder="Describe your issue"></textarea>
      <input id="file" type="file" accept="image/*" />
      <button onclick="createTicket()">Submit Ticket</button>

      <p id="createResult"></p>
    </div>

    <hr>

    <!-- MY TICKETS -->
    <div class="card">
      <h3>My Tickets</h3>
      <div id="tickets">Loading…</div>
    </div>

    <hr>

    <!-- CONVERSATION -->
    <div class="card">
      <h3>Conversation</h3>
      <div id="conversation">Select a ticket</div>

      <button id="closeBtn"
        style="display:none; background:#dc2626;"
        onclick="closeTicket()">
        Close Ticket
      </button>

      <textarea id="replyText" rows="4" placeholder="Reply…"></textarea>
      <button onclick="sendReply()">Send Reply</button>
    </div>

  </section>

</main>

<footer>
  © InfraForge Labs · Support
</footer>

<script>
const API = "/support/api";
let token = localStorage.getItem("support_token");
let selectedCode = null;

/* ================= AUTH ================= */
async function login() {
  const res = await fetch(`${API}/user/auth`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email: loginEmail.value,
      password: loginPassword.value,
      fullName: "login"
    })
  });

  const data = await res.json();
  if (!data.ok) {
    loginResult.textContent = data.error;
    return;
  }

  localStorage.setItem("support_token", data.token);
  token = data.token;
  showDashboard();
}

function logout() {
  localStorage.removeItem("support_token");
  location.reload();
}

/* ================= DASHBOARD ================= */
function showDashboard() {
  loginSection.style.display = "none";
  dashboardSection.style.display = "block";
  loadTickets();
}

/* ================= CREATE TICKET ================= */
async function createTicket() {
  const form = new FormData();
  form.append("subject", subject.value);
  form.append("message", message.value);
  if (file.files[0]) form.append("file", file.files[0]);

  const res = await fetch(`${API}/ticket`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: form
  });

  const data = await res.json();
  if (!data.ok) {
    createResult.textContent = data.error;
    return;
  }

  createResult.textContent = "Ticket created: " + data.ticketCode;
  subject.value = "";
  message.value = "";
  file.value = "";
  loadTickets();
}

/* ================= LOAD TICKETS ================= */
async function loadTickets() {
  const res = await fetch(`${API}/user/tickets`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  const data = await res.json();
  tickets.innerHTML =
    data.tickets.length === 0
      ? "No tickets"
      : data.tickets.map(t => `
        <div class="ticket-item" onclick="openTicket('${t.ticket_code}')">
          ${t.subject}
          <span class="badge">${t.status.toUpperCase()}</span>
        </div>
      `).join("");
}

/* ================= OPEN TICKET ================= */
async function openTicket(code) {
  selectedCode = code;
  closeBtn.style.display = "block";

  const res = await fetch(`${API}/user/ticket/${code}`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  const data = await res.json();
  conversation.innerHTML =
    data.replies.map(r => `
      <div>
        <strong>${r.author_name}</strong><br>
        ${r.body}
      </div>
    `).join("");
}

/* ================= REPLY ================= */
async function sendReply() {
  if (!selectedCode || !replyText.value.trim()) return;

  const f = new FormData();
  f.append("message", replyText.value);

  await fetch(`${API}/user/reply/${selectedCode}`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: f
  });

  replyText.value = "";
  openTicket(selectedCode);
}

/* ================= CLOSE ================= */
async function closeTicket() {
  const f = new FormData();
  f.append("message", "[User closed ticket]");

  await fetch(`${API}/user/reply/${selectedCode}`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: f
  });

  loadTickets();
}

/* ================= INIT ================= */
if (token) showDashboard();
</script>

</body>
</html>
