<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Support · InfraForge Labs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .card { max-width: 720px; margin: auto; }
    input, textarea, button { width: 100%; padding: 10px; margin: 8px 0; }
    .hidden { display: none; }
    .badge { font-size: 12px; padding: 2px 8px; border-radius: 6px; background:#2563eb; }
    .logout { float:right; color:#ef4444; cursor:pointer; }
  </style>
</head>
<body>

<header>
  <img src="/logo.png" class="logo" />
  <h1>Support</h1>
  <p class="subtitle">InfraForge · DevOpsMind · InfraForge Labs</p>
</header>

<main>
  <a href="/">← Back to InfraForge Labs</a>

  <!-- LOGIN -->
  <section id="login" class="card">
    <h3>Login / Register</h3>
    <input id="fullName" placeholder="Full name" />
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <p id="loginMsg"></p>
  </section>

  <!-- APP -->
  <section id="app" class="hidden">

    <div class="card">
      <h3>Create Ticket <span class="logout" onclick="logout()">Logout</span></h3>
      <input id="subject" placeholder="Subject" />
      <textarea id="message" placeholder="Describe your issue"></textarea>
      <input id="file" type="file" />
      <button onclick="createTicket()">Submit Ticket</button>
      <p id="createMsg"></p>
    </div>

    <div class="card">
      <h3>My Tickets</h3>
      <div id="tickets">Loading…</div>
    </div>

    <div class="card">
      <h3>Conversation</h3>
      <div id="conversation">Select a ticket</div>
    </div>

  </section>
</main>

<script>
const API = "/support/api";
let token = localStorage.getItem("support_token");
let selected = null;

if (token) showApp();

/* ---------- AUTH ---------- */
async function login() {
  const res = await fetch(`${API}/user/auth`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      fullName: fullName.value,
      email: email.value,
      password: password.value
    })
  });

  const data = await res.json();
  if (!data.ok) return loginMsg.textContent = data.error;

  localStorage.setItem("support_token", data.token);
  showApp();
}

function logout() {
  localStorage.removeItem("support_token");
  location.reload();
}

function showApp() {
  login.classList.add("hidden");
  app.classList.remove("hidden");
  loadTickets();
}

/* ---------- CREATE TICKET ---------- */
async function createTicket() {
  const form = new FormData();
  form.append("fullName", fullName.value);
  form.append("email", email.value);
  form.append("password", password.value);
  form.append("subject", subject.value);
  form.append("message", message.value);
  if (file.files[0]) form.append("file", file.files[0]);

  const res = await fetch(`${API}/ticket`, {
    method:"POST",
    body: form
  });

  const data = await res.json();
  if (!data.ok) return createMsg.textContent = data.error;

  createMsg.textContent = "Ticket created: " + data.ticketCode;
  loadTickets();
}

/* ---------- MY TICKETS ---------- */
async function loadTickets() {
  const res = await fetch(`${API}/user/tickets`, {
    headers:{ Authorization:`Bearer ${localStorage.getItem("support_token")}` }
  });
  const data = await res.json();

  tickets.innerHTML = data.tickets.length === 0
    ? "No tickets"
    : data.tickets.map(t =>
        `<p onclick="openTicket('${t.ticket_code}')">
          ${t.subject} <span class="badge">${t.status}</span>
        </p>`
      ).join("");
}

/* ---------- OPEN TICKET ---------- */
async function openTicket(code) {
  selected = code;

  const res = await fetch(`${API}/user/ticket/${code}`, {
    headers:{ Authorization:`Bearer ${localStorage.getItem("support_token")}` }
  });
  const data = await res.json();

  conversation.innerHTML = data.replies.map(r =>
    `<p><strong>${r.author_name}</strong><br>${r.body}</p>`
  ).join("");
}
</script>

</body>
</html>
