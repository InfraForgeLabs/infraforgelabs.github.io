<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Support · InfraForge Labs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/style.css">
  <style>
    .card { max-width: 720px; margin: auto; }
    input, textarea, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
    }
    .reply {
      border-top: 1px solid #333;
      padding-top: 12px;
      margin-top: 12px;
    }
    img {
      max-width: 100%;
      border-radius: 6px;
      margin-top: 8px;
    }
  </style>
</head>

<body>

<header>
  <img src="/logo.png" class="logo" alt="InfraForge Labs logo">
  <h1>Support</h1>
  <p class="subtitle">InfraForge · DevOpsMind · InfraForge Labs</p>
</header>

<main>

  <div class="breadcrumb">
    <a href="/">← Back to InfraForge Labs</a>
  </div>

  <!-- CREATE TICKET -->
  <section id="authSection">
    <div class="card">
      <h3>Create Support Ticket</h3>

      <input id="fullName" placeholder="Full name" required>
      <input id="email" type="email" placeholder="Email" required>
      <input id="password" type="password" placeholder="Password" required>

      <input id="subject" placeholder="Subject" required>
      <textarea id="message" rows="6" placeholder="Describe your issue" required></textarea>

      <input id="file" type="file" accept="image/*">

      <button id="submitBtn">Submit Ticket</button>

      <p id="result"></p>
    </div>
  </section>

  <!-- TICKET VIEW -->
  <section id="ticketSection" style="display:none;">
    <div class="card">
      <h3>Ticket Conversation</h3>
      <div id="conversation"></div>

      <h4>Reply</h4>
      <textarea id="replyText" rows="4"></textarea>
      <input id="replyFile" type="file" accept="image/*">
      <button id="replyBtn">Send Reply</button>
    </div>
  </section>

</main>

<footer>
  © InfraForge Labs · Support
</footer>

<script>
(function () {
  const API = "/support/api";

  let token = localStorage.getItem("support_token");
  let ticketCode = null;

  const authSection = document.getElementById("authSection");
  const ticketSection = document.getElementById("ticketSection");
  const result = document.getElementById("result");
  const conversation = document.getElementById("conversation");

  const submitBtn = document.getElementById("submitBtn");
  const replyBtn = document.getElementById("replyBtn");

  function qs(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  /* ---------------- TOKEN LOGIN (EMAIL LINK) ---------------- */

  async function tokenLogin(ticket, oneTimeToken) {
    const res = await fetch(API + "/user/token-login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token: oneTimeToken })
    });

    const data = await res.json();
    if (!data.ok) {
      result.textContent = "Link expired or invalid.";
      return;
    }

    localStorage.setItem("support_token", data.token);
    token = data.token;
    ticketCode = data.ticketCode;

    history.replaceState({}, "", "/support/?ticket=" + ticketCode);
    loadTicket();
  }

  /* ---------------- CREATE TICKET ---------------- */

  async function createTicket() {
    const form = new FormData();
    form.append("fullName", fullName.value);
    form.append("email", email.value);
    form.append("password", password.value);
    form.append("subject", subject.value);
    form.append("message", message.value);
    if (file.files[0]) form.append("file", file.files[0]);

    const res = await fetch(API + "/ticket", {
      method: "POST",
      body: form
    });

    const data = await res.json();
    if (!data.ok) {
      result.textContent = data.error || "Failed to create ticket";
      return;
    }

    localStorage.setItem("support_token", data.token);
    token = data.token;
    ticketCode = data.ticketCode;

    result.textContent = "Ticket created successfully. Ticket ID: " + ticketCode;
    loadTicket();
  }

  /* ---------------- LOAD TICKET ---------------- */

  async function loadTicket() {
    const res = await fetch(API + "/user/ticket/" + ticketCode, {
      headers: { Authorization: "Bearer " + token }
    });

    const data = await res.json();
    if (!data.ok) return;

    authSection.style.display = "none";
    ticketSection.style.display = "block";

    conversation.innerHTML = data.replies.map(function (r) {
      let html = "<div class='reply'><strong>" +
        r.author_type + "</strong><br>" +
        r.body;

      if (r.attachments) {
        r.attachments.forEach(function (a) {
          if (a.mime_type.startsWith("image/")) {
            html += "<img src='" + a.public_url + "'>";
          } else {
            html += "<a href='" + a.public_url + "'>" + a.filename + "</a>";
          }
        });
      }

      html += "</div>";
      return html;
    }).join("");
  }

  /* ---------------- SEND REPLY ---------------- */

  async function sendReply() {
    const form = new FormData();
    form.append("message", replyText.value);
    if (replyFile.files[0]) form.append("file", replyFile.files[0]);

    const res = await fetch(API + "/user/reply/" + ticketCode, {
      method: "POST",
      headers: { Authorization: "Bearer " + token },
      body: form
    });

    const data = await res.json();
    if (data.ok) {
      replyText.value = "";
      replyFile.value = "";
      loadTicket();
    }
  }

  /* ---------------- EVENTS ---------------- */

  submitBtn.addEventListener("click", createTicket);
  replyBtn.addEventListener("click", sendReply);

  /* ---------------- AUTO INIT ---------------- */

  const linkTicket = qs("ticket");
  const linkToken = qs("token");

  if (linkTicket && linkToken) {
    ticketCode = linkTicket;
    tokenLogin(linkTicket, linkToken);
  } else if (token && linkTicket) {
    ticketCode = linkTicket;
    loadTicket();
  }
})();
</script>

</body>
</html>
