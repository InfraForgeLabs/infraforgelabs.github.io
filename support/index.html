<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Support · InfraForge Labs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .card { max-width: 760px; margin: auto; }
    input, textarea, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
    }
    .ticket-item { cursor: pointer; padding: 6px 0; }
    .ticket-item:hover { text-decoration: underline; }

    .badge {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-left: 6px;
      background: #2563eb;
      color: #fff;
    }
    .badge.unread { background:#dc2626 }
    .logout {
      float: right;
      cursor: pointer;
      color: #f87171;
      font-size: 14px;
    }
    button[disabled] {
      opacity: .5;
      cursor: not-allowed;
    }
    hr { margin: 20px 0; }
  </style>
</head>

<body>

<header>
  <img src="/logo.png" class="logo">
  <h1>Support</h1>
  <p class="subtitle">InfraForge · DevOpsMind · InfraForge Labs</p>
</header>

<main>
  <div class="breadcrumb">
    <a href="/">← Back to InfraForge Labs</a>
  </div>

  <!-- ================= LOGIN ================= -->
  <section id="loginSection">
    <div class="card">
      <h3>Password Login</h3>
      <input id="loginFullName" placeholder="Full name">
      <input id="loginEmail" type="email" placeholder="Email">
      <input id="loginPassword" type="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <p id="loginResult"></p>

      <hr>

      <h3>Magic-Link Login</h3>
      <input id="magicEmail" type="email" placeholder="Email">
      <button onclick="sendMagicLink()">Send Magic Link</button>
      <p id="magicResult"></p>
    </div>
  </section>

  <!-- ================= DASHBOARD ================= -->
  <section id="dashboardSection" style="display:none;">

    <!-- CREATE TICKET -->
    <div class="card">
      <h3>
        Create Ticket
        <span class="logout" onclick="logout()">Logout</span>
      </h3>

      <input id="subject" placeholder="Subject">
      <textarea id="message" rows="4" placeholder="Describe your issue"></textarea>
      <button onclick="createTicket()">Submit Ticket</button>
      <p id="createResult"></p>
    </div>

    <hr>

    <!-- MY TICKETS -->
    <div class="card">
      <h3>My Tickets</h3>
      <div id="tickets">Loading…</div>
    </div>

    <hr>

    <!-- CONVERSATION -->
    <div class="card">
      <h3>Conversation</h3>
      <div id="conversation">Select a ticket</div>

      <button id="closeBtn" style="display:none;background:#dc2626"
        onclick="closeTicket()">Close Ticket</button>

      <button id="reopenBtn" style="display:none;background:#16a34a"
        onclick="reopenTicket()">Reopen Ticket</button>

      <textarea id="replyText" rows="4" placeholder="Reply…"></textarea>
      <button id="replyBtn" onclick="sendReply()">Send Reply</button>
    </div>

  </section>
</main>

<footer>© InfraForge Labs · Support</footer>

<script>
const API = "/support/api";
let token = localStorage.getItem("support_token");
let selectedCode = null;
let selectedStatus = null;

/* ================= PASSWORD LOGIN ================= */
async function login() {
  if (!loginFullName.value || !loginEmail.value || !loginPassword.value) {
    loginResult.textContent = "All fields required";
    return;
  }

  const res = await fetch(`${API}/user/auth`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      fullName: loginFullName.value,
      email: loginEmail.value,
      password: loginPassword.value
    })
  });

  const data = await res.json();
  if (!data.ok) return loginResult.textContent = data.error;

  localStorage.setItem("support_token", data.token);
  token = data.token;
  showDashboard();
}

/* ================= MAGIC LINK ================= */
async function sendMagicLink() {
  if (!magicEmail.value) {
    magicResult.textContent = "Email required";
    return;
  }

  const res = await fetch(`${API}/user/token-login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: magicEmail.value })
  });

  const data = await res.json();
  magicResult.textContent =
    data.ok
      ? "Magic link sent to your email"
      : data.error || "Failed";
}

/* ================= LOGOUT ================= */
function logout() {
  localStorage.clear();
  location.href = "/support/";
}

/* ================= DASHBOARD ================= */
function showDashboard() {
  loginSection.style.display = "none";
  dashboardSection.style.display = "block";
  loadTickets();
}

/* ================= CREATE TICKET ================= */
async function createTicket() {
  const form = new FormData();
  form.append("subject", subject.value);
  form.append("message", message.value);

  const res = await fetch(`${API}/ticket`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: form
  });

  const data = await res.json();
  if (!data.ok) return createResult.textContent = data.error;

  createResult.textContent = "Ticket created: " + data.ticketCode;
  subject.value = "";
  message.value = "";
  loadTickets();
}

/* ================= LOAD TICKETS ================= */
async function loadTickets() {
  const res = await fetch(`${API}/user/tickets`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  const data = await res.json();
  tickets.innerHTML =
    data.tickets.length === 0
      ? "No tickets"
      : data.tickets.map(t => `
        <div class="ticket-item" onclick="openTicket('${t.ticket_code}')">
          ${t.subject}
          <span class="badge ${t.has_unread_user ? "unread" : ""}">
            ${t.has_unread_user ? "NEW" : t.status.toUpperCase()}
          </span>
        </div>
      `).join("");
}

/* ================= OPEN TICKET ================= */
async function openTicket(code) {
  selectedCode = code;

  const res = await fetch(`${API}/user/ticket/${code}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();

  selectedStatus = data.ticket.status;

  conversation.innerHTML =
    data.replies.map(r =>
      `<div><strong>${r.author_name}</strong><br>${r.body}</div>`
    ).join("");

  replyText.disabled = replyBtn.disabled = selectedStatus === "closed";
  closeBtn.style.display = selectedStatus === "open" ? "block" : "none";
  reopenBtn.style.display = selectedStatus === "closed" ? "block" : "none";
}

/* ================= REPLY ================= */
async function sendReply() {
  if (selectedStatus === "closed") return;

  const f = new FormData();
  f.append("message", replyText.value);

  await fetch(`${API}/user/reply/${selectedCode}`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: f
  });

  replyText.value = "";
  openTicket(selectedCode);
}

/* ================= STATUS ================= */
async function closeTicket() {
  await sendSystem("[User closed ticket]");
  loadTickets();
}
async function reopenTicket() {
  await sendSystem("[User reopened ticket]");
  loadTickets();
}
async function sendSystem(msg) {
  const f = new FormData();
  f.append("message", msg);

  await fetch(`${API}/user/reply/${selectedCode}`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: f
  });
}

/* ================= MAGIC LINK AUTO LOGIN ================= */
const qs = new URLSearchParams(location.search);
if (qs.get("token")) {
  localStorage.setItem("support_token", qs.get("token"));
  token = qs.get("token");
  history.replaceState({}, "", "/support/");
}

if (token) showDashboard();
</script>

</body>
</html>
