<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Support · InfraForge Labs</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/style.css">

<style>
.card { max-width:760px; margin:20px auto; }
input, textarea, button { width:100%; padding:10px; margin:8px 0; }
.hidden { display:none; }
.logout { float:right; cursor:pointer; color:#ef4444; }
</style>
</head>

<body>

<header>
  <h1>Support</h1>
</header>

<main>
<a href="/">← Back</a>

<section id="loginSection" class="card">
  <input id="fullName" placeholder="Full name">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <p id="loginMsg"></p>
</section>

<section id="appSection" class="hidden">

  <div class="card">
    <h3>Create Ticket <span id="logoutBtn" class="logout">Logout</span></h3>
    <input id="subject" placeholder="Subject">
    <textarea id="message" placeholder="Describe your issue"></textarea>
    <input id="file" type="file">
    <button id="createBtn">Submit Ticket</button>
    <p id="createMsg"></p>
  </div>

  <div class="card">
    <h3>My Tickets</h3>
    <div id="ticketsList">Loading…</div>
  </div>

</section>
</main>

<script>
const API = "https://api.infraforgelabs.in/support";

/* ---------- HELPERS ---------- */
function getToken() {
  return localStorage.getItem("support_token");
}
function logout() {
  localStorage.removeItem("support_token");
  appSection.classList.add("hidden");
  loginSection.classList.remove("hidden");
}

/* ---------- DOM ---------- */
const loginSection = document.getElementById("loginSection");
const appSection = document.getElementById("appSection");

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const createBtn = document.getElementById("createBtn");

const fullName = document.getElementById("fullName");
const email = document.getElementById("email");
const password = document.getElementById("password");

const subject = document.getElementById("subject");
const message = document.getElementById("message");
const file = document.getElementById("file");

const loginMsg = document.getElementById("loginMsg");
const createMsg = document.getElementById("createMsg");
const ticketsList = document.getElementById("ticketsList");

/* ---------- INIT ---------- */
if (getToken()) showApp();

/* ---------- AUTH ---------- */
loginBtn.onclick = async () => {
  const res = await fetch(`${API}/user/auth`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      fullName: fullName.value,
      email: email.value,
      password: password.value
    })
  });

  const data = await res.json();
  if (!data.ok) return loginMsg.textContent = data.error;

  localStorage.setItem("support_token", data.token);
  showApp();
};

logoutBtn.onclick = logout;

/* ---------- APP ---------- */
function showApp() {
  loginSection.classList.add("hidden");
  appSection.classList.remove("hidden");
  loadTickets();
}

/* ---------- LOAD TICKETS ---------- */
async function loadTickets() {
  const res = await fetch(`${API}/user/tickets`, {
    headers: { Authorization: `Bearer ${getToken()}` }
  });

  const data = await res.json();
  ticketsList.innerHTML = (data.tickets || [])
    .map(t => `<div>${t.subject}</div>`)
    .join("");
}

/* ---------- ✅ CREATE TICKET (THIS WAS MISSING) ---------- */
createBtn.onclick = async () => {
  createMsg.textContent = "";

  if (!subject.value || !message.value) {
    createMsg.textContent = "Subject and message required";
    return;
  }

  const fd = new FormData();
  fd.append("subject", subject.value);
  fd.append("message", message.value);
  if (file.files[0]) fd.append("file", file.files[0]);

  const res = await fetch(`${API}/user/ticket`, {
    method: "POST",
    headers: { Authorization: `Bearer ${getToken()}` },
    body: fd
  });

  const data = await res.json();
  if (!data.ok) {
    createMsg.textContent = data.error || "Failed";
    return;
  }

  subject.value = "";
  message.value = "";
  file.value = "";
  createMsg.textContent = `Ticket created: ${data.ticketCode}`;

  loadTickets();
};
</script>

</body>
</html>
