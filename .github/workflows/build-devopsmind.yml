name: DevOpsMind Production Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:

# =====================================================
# üèó BUILD MATRIX
# =====================================================
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-14, windows-latest]

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:

# -------------------------------------------------
# 1Ô∏è‚É£ Checkout Release Repo
# -------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

# -------------------------------------------------
# 2Ô∏è‚É£ Checkout DevOpsMind Source
# -------------------------------------------------
      - uses: actions/checkout@v4
        with:
          repository: InfraForgeLabs/DevOpsMind
          path: devopsmind-src
          token: ${{ secrets.DEVOPSMIND_READ_TOKEN }}
          fetch-depth: 0

# -------------------------------------------------
# 3Ô∏è‚É£ Setup Python
# -------------------------------------------------
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

# -------------------------------------------------
# 4Ô∏è‚É£ Install Dependencies
# -------------------------------------------------
      - name: Install dependencies
        shell: bash
        working-directory: devopsmind-src
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller rich
          pip install -e .[all]

# -------------------------------------------------
# 5Ô∏è‚É£ Read Version (UNCHANGED LOGIC)
# -------------------------------------------------
      - name: Read version
        id: version
        shell: bash
        run: |
          VERSION=$(curl -fsSL \
            https://raw.githubusercontent.com/InfraForgeLabs/infraforgelabs.github.io/main/meta/devopsmind/version.json \
            | sed -n 's/.*"latest_version"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')

          if [ -z "$VERSION" ]; then
            echo "‚ùå Failed to read version"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

# -------------------------------------------------
# 6Ô∏è‚É£ Create Tag (Linux only)
# -------------------------------------------------
      - name: Create tag
        if: runner.os == 'Linux'
        shell: bash
        run: |
          git config user.name "InfraForgeLabs Bot"
          git config user.email "ci@infraforgelabs.dev"

          TAG="v${{ steps.version.outputs.version }}-devopsmind"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag already exists"
          else
            git tag "$TAG"
            git push origin "$TAG"
          fi

# -------------------------------------------------
# 7Ô∏è‚É£ Build PyInstaller (onedir)
# -------------------------------------------------
      - name: Build binary
        shell: bash
        working-directory: devopsmind-src
        run: |
          pyinstaller --clean --noconfirm devopsmind.spec

# =====================================================
# üêß LINUX ‚Üí APPIMAGE (FIXED)
# =====================================================
      - name: Install FUSE
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2

      - name: Build AppImage
        if: runner.os == 'Linux'
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}

          mkdir -p DevOpsMind.AppDir/usr/bin
          cp -r devopsmind-src/dist/devopsmind/* DevOpsMind.AppDir/usr/bin/

          # Create dummy icon (required)
          mkdir -p DevOpsMind.AppDir
          convert -size 256x256 xc:blue DevOpsMind.AppDir/devopsmind.png

          cat <<EOF > DevOpsMind.AppDir/AppRun
          #!/bin/bash
          HERE="\$(dirname "\$(readlink -f "\$0")")"
          exec "\$HERE/usr/bin/devopsmind"
          EOF
          chmod +x DevOpsMind.AppDir/AppRun

          cat <<EOF > DevOpsMind.AppDir/devopsmind.desktop
          [Desktop Entry]
          Name=DevOpsMind
          Exec=devopsmind
          Icon=devopsmind
          Type=Application
          Categories=Development;
          EOF

          wget -O appimagetool \
            https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage

          chmod +x appimagetool

          ./appimagetool DevOpsMind.AppDir DevOpsMind-${VERSION}-x86_64.AppImage

          mkdir artifacts
          mv DevOpsMind-${VERSION}-x86_64.AppImage artifacts/


# =====================================================
# üçé MACOS ‚Üí DMG (UNSIGNED)
# =====================================================
      - name: Build macOS DMG
        if: runner.os == 'macOS'
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}

          mkdir -p DevOpsMind.app/Contents/MacOS
          cp -r devopsmind-src/dist/devopsmind/* DevOpsMind.app/Contents/MacOS/

          cat <<EOF > DevOpsMind.app/Contents/Info.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key>
            <string>DevOpsMind</string>
            <key>CFBundleExecutable</key>
            <string>devopsmind</string>
            <key>CFBundleIdentifier</key>
            <string>com.infraforgelabs.devopsmind</string>
            <key>CFBundleVersion</key>
            <string>${VERSION}</string>
          </dict>
          </plist>
          EOF

          brew install create-dmg

          create-dmg DevOpsMind-${VERSION}.dmg DevOpsMind.app

          mkdir artifacts
          mv DevOpsMind-${VERSION}.dmg artifacts/

# =====================================================
# ü™ü WINDOWS ‚Üí NSIS (FIXED PATH)
# =====================================================
      - name: Install NSIS
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install nsis -y

      - name: Build Windows Installer
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $VERSION="${{ steps.version.outputs.version }}"

          @"
          OutFile "DevOpsMind-$VERSION-Installer.exe"
          InstallDir "\$PROGRAMFILES\DevOpsMind"

          Section
            SetOutPath "\$INSTDIR"
            File /r "devopsmind-src\dist\devopsmind\*"
            CreateShortcut "\$DESKTOP\DevOpsMind.lnk" "\$INSTDIR\devopsmind.exe"
          SectionEnd
          "@ | Out-File installer.nsi -Encoding ascii

          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi

          New-Item -ItemType Directory -Force artifacts
          Move-Item "DevOpsMind-$VERSION-Installer.exe" artifacts/

# -------------------------------------------------
# üîê CHECKSUM
# -------------------------------------------------
      - name: Generate checksums (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd artifacts || exit 0
          for file in *; do
            shasum -a 256 "$file" > "$file.sha256"
          done

      - name: Generate checksums (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Get-ChildItem artifacts | ForEach-Object {
            $hash = Get-FileHash $_.FullName -Algorithm SHA256
            "$($hash.Hash.ToLower())  $($_.Name)" |
              Out-File "$($_.FullName).sha256" -Encoding ascii
          }

# -------------------------------------------------
# üì¶ Upload Artifacts (CRITICAL)
# -------------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-artifacts
          path: artifacts/*

# =====================================================
# üöÄ RELEASE
# =====================================================
  release:
    needs: build
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      # Download ALL artifacts from matrix builds
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # Flatten artifacts safely
      - name: Flatten artifacts
        run: |
          mkdir final
          find artifacts -type f -exec cp {} final/ \;

      # Publish GitHub Release
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}-devopsmind
          name: DevOpsMind v${{ needs.build.outputs.version }}
          files: final/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
