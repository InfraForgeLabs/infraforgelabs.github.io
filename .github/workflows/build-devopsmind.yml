name: Build DevOpsMind Binaries

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            output: devopsmind-linux-x86_64
          - os: macos-14
            output: devopsmind-macos-arm64
          - os: windows-latest
            output: devopsmind-windows.exe

    steps:
      # -------------------------------------------------
      # 1️⃣ Checkout website repo (publish destination)
      # -------------------------------------------------
      - name: Checkout website repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # needed for rebase

      # -------------------------------------------------
      # 2️⃣ Checkout DevOpsMind source (private, read-only)
      # -------------------------------------------------
      - name: Checkout DevOpsMind source
        uses: actions/checkout@v4
        with:
          repository: InfraForgeLabs/devopsmind
          token: ${{ secrets.DEVOPSMIND_READ_TOKEN }}
          path: devopsmind

      # -------------------------------------------------
      # 3️⃣ Setup Python
      # -------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------------------------------------------------
      # 4️⃣ Install PyInstaller
      # -------------------------------------------------
      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
        shell: bash

      # -------------------------------------------------
      # 5️⃣ Read DevOpsMind VERSION (authoritative)
      # -------------------------------------------------
      - name: Read DevOpsMind version
        id: version
        run: |
          VERSION=$(cat devopsmind/VERSION)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
        shell: bash

      # -------------------------------------------------
      # 6️⃣ Build DevOpsMind binary (src-layout + __main__)
      # -------------------------------------------------
      - name: Build DevOpsMind binary
        working-directory: devopsmind
        run: |
          pyinstaller \
            --onefile \
            --clean \
            --name devopsmind \
            --add-data "VERSION:." \
            --collect-all rich \
            --paths src \
            src/devopsmind/__main__.py
        shell: bash

      # -------------------------------------------------
      # 7️⃣ Publish binary into versioned directory
      # -------------------------------------------------
      - name: Publish binary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TARGET_DIR="meta/devopsmind/download/${VERSION}"

          mkdir -p "${TARGET_DIR}"

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            mv devopsmind/dist/devopsmind.exe "${TARGET_DIR}/${{ matrix.output }}"
          else
            mv devopsmind/dist/devopsmind "${TARGET_DIR}/${{ matrix.output }}"
          fi
        shell: bash

      # -------------------------------------------------
      # 8️⃣ Sync global version.json (once per release)
      # -------------------------------------------------
      - name: Update version.json
        if: matrix.os == 'ubuntu-latest'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DATE=$(date +%Y-%m-%d)

          jq \
            --arg v "$VERSION" \
            --arg d "$DATE" \
            '.latest_version = $v | .released_at = $d' \
            meta/devopsmind/version.json \
            > meta/devopsmind/version.tmp.json

          mv meta/devopsmind/version.tmp.json meta/devopsmind/version.json
        shell: bash

      # -------------------------------------------------
      # 9️⃣ Commit + rebase + push (Pages-safe)
      # -------------------------------------------------
      - name: Commit and push artifacts
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          git config user.name "InfraForgeLabs Bot"
          git config user.email "ci@infraforgelabs.dev"

          git add meta/devopsmind/download/${VERSION}/${{ matrix.output }}
          git add meta/devopsmind/version.json

          git commit -m "DevOpsMind v${VERSION} binaries" || exit 0

          # Rebase to avoid GitHub Pages race
          git pull --rebase origin main

          git push
